import groovy.sql.Sql

repositories {
	mavenCentral()
}

configurations {
    driver
}

dependencies {
	driver 'mysql:mysql-connector-java:5.1.6'
}

configurations.driver.each {
	GroovyObject.class.classLoader.addURL it.toURL()
}

task loadDriver << {
	Class.forName(getProperty(db))
}

task createUsers(dependsOn: loadDriver) << {
	execute { sql -> 
		Map entries = [users.split(','), pass.split(',')].transpose().collectEntries()
		entries.each {
			sql.execute "CREATE USER ${it.key}@$dburl IDENTIFIED BY ${it.value};"
			println "User ${it.key} with password ${it.value} has been created." 
		}
	}
}

task removeUsers(dependsOn: loadDriver) << {
	execute	{ sql ->
		users.split(',').each {
			sql.execute "DROP USER $it@$dburl;"
			println "User $it has been removed." 
		}
	}
}

def execute(closure) {
	def sql = Sql.newInstance(dburl, admin, adminpass)
	closure(sql)
}